# azure-pipelines.yml

trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  # Replace with your actual Grafana Cloud k6 Project ID
  K6_CLOUD_PROJECT_ID: 6283091

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '22.x'
    displayName: 'Install Node.js'

  - script: |
      npm ci
    displayName: 'Install npm dependencies'

  - script: |
      npx playwright install --with-deps
    displayName: 'Install Playwright browsers'

  # Run BDD Tests (UI + API via Cucumber)
  - script: |
      npm run test:bdd
    displayName: 'Run BDD Tests (Cucumber + Playwright)'

  # Generate Beautiful Cucumber HTML Report
  - script: |
      npm run report
    displayName: 'Generate Cucumber HTML Report'

  # Run k6 Load Test → Send to Grafana Cloud
  - script: |
      k6 cloud performance-tests/load.js
    env:
      K6_CLOUD_PROJECT_ID: $(K6_CLOUD_PROJECT_ID)
    displayName: 'k6 Load Test → Grafana Cloud'

  # Run k6 Spike Test → Send to Grafana Cloud
  - script: |
      k6 cloud performance-tests/spike.js
    env:
      K6_CLOUD_PROJECT_ID: $(K6_CLOUD_PROJECT_ID)
    displayName: 'k6 Spike Test → Grafana Cloud'

  # Publish Reports as Pipeline Artifacts
  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: 'reports/html-report'
      artifact: 'Cucumber-BDD-Report'
      publishLocation: 'pipeline'
    displayName: 'Publish Cucumber BDD Report'

  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: 'reports/k6-load-report.html'
      artifact: 'k6-Load-Report'
      publishLocation: 'pipeline'
    condition: succeededOrFailed()
    displayName: 'Publish k6 Load Report (Local HTML)'

  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: 'reports/k6-spike-report.html'
      artifact: 'k6-Spike-Report'
      publishLocation: 'pipeline'
    condition: succeededOrFailed()
    displayName: 'Publish k6 Spike Report (Local HTML)'

  # Optional: Publish JSON results if you save them
  # - task: PublishPipelineArtifact@1
  #   inputs:
  #     targetPath: 'results-load.json'
  #     artifact: 'k6-Load-JSON'
  